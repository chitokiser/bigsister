<!-- agent.html (드롭다운/월렛 통합 버전) -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>LocaMate · 내 콘솔</title>
  <link rel="stylesheet" href="styles.css">

  <!-- 로컬 개발용 App Check 디버그 토큰 -->
  <script>self.FIREBASE_APPCHECK_DEBUG_TOKEN = 'ae36c5c3-0aa5-42c6-b9bb-1ecef4d369a1';</script>

  <!-- ✅ Firebase compat SDKs (순서 중요) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check-compat.js"></script>

  <!-- 프로젝트 설정 / AppCheck 초기화 -->
  <script src="./src/config.js"></script>
  <script src="./src/firebase-init.js"></script>

  <style>
    .container{max-width:1080px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    .cols{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column}
    .card{padding:12px;border:1px solid #222;border-radius:12px;background:#0f1218}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #333;border-radius:999px;font-size:12px;color:#ccd}
    .muted{color:#9aa0a6}
    .small{font-size:12px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #334;background:#1a2130;color:#e6ebff;cursor:pointer}
    .btn.outline{background:#0f1218}
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .card img.square{width:100%;aspect-ratio:1/1;height:auto;object-fit:cover;border-radius:12px}
    .hidden{display:none}
    input,select,textarea{background:#0b0d12;border:1px solid #223;border-radius:8px;color:#eee;padding:8px}
    label{font-size:12px;color:#9aa0a6}
  </style>
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <h2>내 로컬메이트 콘솔</h2>
    <div class="row">
      <span id="agent-status" class="muted small">로그인 확인 중…</span>
      <span id="agent-approve-badge" class="pill">승인 상태: -</span>
    </div>

    <!-- 미리보기 카드 -->
    <section class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">미리보기</h3>
      <div class="grid-cards">
        <div class="card" style="padding:0">
          <div class="preview-media"
               style="width:clamp(140px, 42vw, 220px); aspect-ratio:16/16; overflow:hidden;
                      background:#111; margin:10px auto 0; border-radius:12px">
            <img id="pv-photo"
                 src="https://placehold.co/400x400?text=Local+Mate"
                 alt="프로필 미리보기"
                 style="width:100%; height:100%; object-fit:contain;">
          </div>

          <div style="padding:10px">
            <div class="row" style="gap:8px">
              <strong id="pv-name">로컬 메이트</strong>
              <span id="pv-topic" class="pill">주제없음</span>
            </div>
            <div class="small muted" id="pv-city"></div>
            <div class="small muted" id="pv-email"></div>

            <p id="pv-bio" class="small" style="margin:10px 0 8px 0">
              간단 소개가 여기에 표시됩니다.
            </p>

            <div id="pv-contact-row" class="row small hidden" style="justify-content:space-between">
              <span id="pv-contact" class="muted"></span>
              <div class="row" style="gap:6px">
                <a id="pv-btn-items" class="btn outline small" href="search.html?tab=items">상품보기</a>
                <a id="pv-btn-blog" class="btn outline small" href="search.html?tab=blog">블로그</a>
                <a id="pv-btn-youtube" class="btn outline small" href="search.html?tab=youtube">유튜브</a>
              </div>
            </div>
          </div>
        </div>

        <div class="small muted" style="align-self:center">
          좌측 카드에 프로필/상품 정보가 미리보기로 나타납니다.
        </div>
      </div>
    </section>

    <!-- 내 프로필 -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">내 프로필</h3>
      <form id="agent-form" class="grid cols">
        <div class="col">
          <label>이름</label>
          <input id="agent-name" placeholder="표시명" required/>
        </div>

        <!-- ✅ 주제: select로 (id 유지: #agent-topic) -->
        <div class="col">
          <label>주요 주제</label>
          <select id="agent-topic">
            <option value="">주제선택</option>
          </select>
        </div>

        <!-- ✅ 나라/도시 드롭다운 -->
        <div class="col">
          <label>나라</label>
          <select id="agent-country">
            <option value="">나라선택</option>
          </select>
        </div>
        <div class="col">
          <label>도시·지역</label>
          <select id="agent-city">
            <option value="">도시/지역 선택</option>
          </select>
        </div>

        <!-- ✅ 월렛 주소 (localmate.js가 저장/로드 처리함) -->
        <div class="col" style="grid-column:1/-1">
          <label>월렛 주소 (EVM)</label>
          <input id="agent-wallet" placeholder="0x로 시작하는 주소" inputmode="text" autocomplete="off"/>
          <div class="small muted" style="margin-top:4px">※ 저장하면 DB의 wallet 필드가 갱신됩니다.</div>
        </div>

        <div class="col" style="grid-column:1/-1">
          <label>소개</label>
          <textarea id="agent-bio" rows="3" placeholder="간단한 소개"></textarea>
        </div>

        <div class="col">
          <label>프로필 사진</label>
          <input id="agent-photo" type="file" accept="image/*"/>
          <img id="agent-photo-preview" class="square hidden" alt="preview" />
          <div id="agent-photo-progress" class="small muted"></div>
        </div>

        <div class="row" style="grid-column:1/-1;justify-content:flex-end">
          <button id="agent-save" class="btn" type="submit">저장</button>
        </div>
      </form>
    </section>

    <!-- 상품 -->
    <section class="card">
      <h3 id="product-form-title" style="margin:0 0 8px 0">상품 등록</h3>
      <form id="product-form" class="grid cols">
        <input type="hidden" id="product-id" />

        <div class="col">
          <label>상품명</label>
          <input id="product-title" placeholder="예: 하롱베이 일일투어" required/>
        </div>

        <div class="col" style="grid-column:1/-1">
          <label>태그 (쉼표로 구분)</label>
          <input id="product-tags" placeholder="ex) 투어, 맛집"/>
        </div>

        <!-- ⬇️ 설명은 텍스트 대신 URL만 입력 -->
        <div class="col" style="grid-column:1/-1">
          <label>설명페이지 URL</label>
          <input id="product-body" type="url" inputmode="url"
                 placeholder="https://example.com/your-product"
                 pattern="https?://.+" required />
          <div class="small muted" style="margin-top:4px">상품 상세를 안내하는 외부 페이지 URL을 넣어주세요.</div>
        </div>

        <!-- ⬇️ 이미지는 1장(썸네일)만 -->
        <div class="col">
          <label>상품 이미지 (1장)</label>
          <input id="product-thumb" type="file" accept="image/*"/>
          <div class="small muted" id="product-thumb-progress"></div>
        </div>

        <div class="col hidden" aria-hidden="true">
          <div class="small muted" id="product-images-progress"></div>
        </div>

        <div class="row" style="grid-column:1/-1;justify-content:flex-end">
          <button id="product-save" class="btn" type="submit">상품 저장</button>
        </div>
      </form>
    </section>

    <!-- 블로그/유튜브 -->
    <section class="card">
      <h3 style="margin:0 0 8px 0">블로그/유튜브 링크</h3>
      <form id="blog-form" class="grid cols">
        <div class="col">
          <label>제목</label>
          <input id="blog-title" placeholder="포스트/영상 제목" required />
        </div>
        <div class="col" style="grid-column:1/-1">
          <label>링크(URL)</label>
          <input id="blog-url" type="url" inputmode="url"
                 placeholder="https://example.com/..." pattern="https?://.+" required />
        </div>
        <div class="row" style="grid-column:1/-1;justify-content:flex-end">
          <button id="blog-save" class="btn" type="submit">링크 저장</button>
        </div>
      </form>
    </section>
  </main>

  <script type="module">
    import './src/app-shell.js';
    import './src/pages/localmate.js';
  </script>

  <!-- 미리보기 동기화 (기존 스크립트에 change 이벤트 추가) -->
  <script>
    (function(){
      const $=s=>document.querySelector(s);
      const map = [
        ['#agent-name','#pv-name',v=>v||'로컬 메이트'],
        ['#agent-topic','#pv-topic',v=>v||'주제없음'],
        ['#agent-bio','#pv-bio',v=>v||''],
        ['#agent-contact','#pv-contact',v=>v||''], // 입력칸이 없어도 안전
        ['#agent-messenger',null,()=>{}]           // 입력칸이 없어도 안전
      ];
      map.forEach(([src,dst,fmt])=>{
        const el=$(src), out=dst?$(dst):null;
        if (!el) return;
        const on=()=>{
          const val=(el.value||'').trim();
          if(out){
            out.textContent=fmt(val);
            const row=$('#pv-contact-row');
            if(row && dst==='#pv-contact'){ row.classList.toggle('hidden', !val); }
          }
        };
        el.addEventListener('input',on);
        el.addEventListener('change',on);   // ⬅️ select 대응
        setTimeout(on,120);
      });

      // 나라/도시 선택 시 미리보기 "나라 도시"로 표시
      const $country = $('#agent-country');
      const $city = $('#agent-city');
      function syncCityPreview(){
        const c=$country?.value||''; const t=$city?.value||'';
        const pv = $('#pv-city'); if (pv) pv.textContent = `${c} ${t}`.trim();
      }
      $country?.addEventListener('change', syncCityPreview);
      $city?.addEventListener('change', syncCityPreview);
      setTimeout(syncCityPreview, 300);

      // 사진 미리보기 동기화
      const prev=$('#pv-photo'), img=$('#agent-photo-preview');
      const syncPhoto=()=>{ if(img && img.src) prev.src = img.src; };
      img?.addEventListener('load', syncPhoto); setTimeout(syncPhoto,800);

      // 로그인 후 링크 구성
      setTimeout(()=>{
        try{
          const uid = firebase.auth().currentUser?.uid;
          if (uid){
            $('#pv-email').textContent = firebase.auth().currentUser?.email || '';
            $('#pv-btn-items').href   = 'search.html?owner='+encodeURIComponent(uid)+'&tab=items';
            $('#pv-btn-blog').href    = 'search.html?owner='+encodeURIComponent(uid)+'&tab=blog';
            $('#pv-btn-youtube').href = 'search.html?owner='+encodeURIComponent(uid)+'&tab=youtube';
          }
        }catch(_){}
      }, 1200);
    })();
  </script>
</body>
</html>
